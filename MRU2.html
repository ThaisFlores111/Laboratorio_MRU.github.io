<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Librer铆a ExcelJS necesaria para im谩genes y formato avanzado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-super-hands-component@4.0.5/dist/aframe-super-hands-component.min.js"></script>
    <title>Movimiento Rectilineo Uniforme</title>
    <style>
        body {
            background-color: #afabab;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #velocidad-panel {
            position: fixed;
            top: 24px;
            left: 24px;
            background: #D8DCF0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #velocidad-panel label {
            font-weight: bold;
            color: #333;
        }
        #velocidad-panel input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Estilo para el nuevo bot贸n de descarga */
        #boton-descargar {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            display: none; /* Se oculta hasta que haya datos */
        }
        #boton-descargar:hover {
            background-color: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            background: #ffdddd;
            color: #a33;
            border: 2px solid #a33;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: sans-serif;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }
        .modal2 {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #66bb6a;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: sans-serif;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="velocidad-panel">
        <div>
            <label for="vel-input">INTRODUCE DATOS <BR></label>
            <label for="vel-input">Velocidad (m/s):</label>
            <input id="vel-input" type="number" min="0.1" step="0.01" value="1" style="width: 80px;">
        </div>
        <button id="boton-descargar">Descargar Excel</button>
    </div>

    <div id="mensajeError" class="modal">
        锔 El carrito debe colocarse justo antes de la fotopuerta 1 para iniciar.
    </div>
    <div id="mensajeExito" class="modal2">
        =D 隆Lo hiciste muy bien! Puedes ver tus resultados en la pizarra y descargar el Excel.
    </div>
    
    <!-- Canvas oculto para generar la textura y el gr谩fico del Excel -->
    <canvas id="grafico" width="400" height="300" style="display: none;"></canvas>

    <a-scene>
        <a-assets>
            <img id="piso" src="Imagenes/piso2.jpg">
            <a-asset-item id="modeloriel" src="modelos/soportemru.glb"></a-asset-item>
            <a-asset-item id="modelocarrito" src="modelos/carritomru.glb"></a-asset-item>
            <a-asset-item id="modelomaquina" src="modelos\maquina_de_aire.glb"></a-asset-item>
            <a-asset-item id="modelo-vernier" src="modelos\vernier.glb"></a-asset-item>
            <a-asset-item id="estante" src="modelos/estantemru.glb"></a-asset-item>
            <a-asset-item id="ventana" src="modelos/ventana1.glb"></a-asset-item>
            <a-asset-item id="modelo-docente" src="modelos\inge.glb"></a-asset-item>
            <a-asset-item id="modeloPuerta" src="modelos/puerta.glb"></a-asset-item>
            <a-asset-item id="modelomesa" src="modelos/mesa.glb"></a-asset-item>
            <a-asset-item id="modelosilla" src="modelos/silla.glb"></a-asset-item>
            <a-asset-item id="componentes1" src="modelos/L.F. Sensor de aceleracion.glb"></a-asset-item>
            <a-asset-item id="componentes2" src="modelos/L.F. Sensor de Luz.glb"></a-asset-item>
        </a-assets>

        <!-- Paredes-->
        <a-box color="#cccccc" width="80" height="30" depth="0.2" position="30.824 6 -90" scale="1.220 1.000 1.000"></a-box>
        <a-box color="#cccccc" width="80" height="30" depth="0.2" position="30.824 6 30" scale="1.220 1.000 1.000"></a-box>
        <a-box color="#cccccc" width="0.2" height="30" depth="120" position="79.052 6 -30" ></a-box>
        <a-box color="#cccccc" width="0.2" height="30" depth="120" position="-17.5 6 -30"></a-box>
        <a-box color="#020512" width="0.2" height="110" depth="124" position="34.321 20 -28.952" rotation="0 0 90" scale="1.220 1.000 1.000"></a-box>
        
        <!-- Piso-->
        <a-plane rotation="-90 0 0" position="30.321 -8 -34.952" src="#piso" scale="1.240 1.100 1.000" width="80" height="120" repeat="4 4"></a-plane>
        
        
        <!-- Puertas-->
         <a-entity gltf-model="#modeloPuerta" position="4.610 2.792 29.769" scale="9.5 11 5"></a-entity>
         <a-entity gltf-model="#modeloPuerta" position="-5.207 2.792 29.769" scale="9.5 11 5"></a-entity>
         
         <!-- sillas-->
         <a-entity gltf-model="#modelosilla" position="-2.206 -4.080 -11.908" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="4.623 -4.080 -11.908" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="44.564 -4.080 -11.908" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="51.804 -4.080 -11.908" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="-2.206 -4.080 -37.934" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="4.623 -4.080 -37.934" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="44.564 -4.080 -37.934" scale="4 4 4"></a-entity>
         <a-entity gltf-model="#modelosilla" position="51.804 -4.080 -37.934" scale="4 4 4"></a-entity>
        
        <!-- AVATAR DOCENTE -->
       <a-entity id="docente-avatar" gltf-model="#modelo-docente" scale="14 14 14" position="68.416 -2 22" rotation="0 90 0"></a-entity>

      <!-- PANEL DE DILOGO -->
      <a-entity id="panel-dialogo" position="60.259 8 29.5" rotation="0 180 0">
        <a-plane width="22" height="13" color="#222"></a-plane>
        <a-text id="texto-dialogo" value="Hola, 驴 en que puedo ayudarte ?" color="#FFF" position="0 0 0.01" width="20" align="center"></a-text>
      </a-entity>
      
      <a-entity id="boton-docente" position="59.915 5 29.5" rotation="0 180 0">
        <a-box width="5" height="2" depth="2" color="#00CFFF"></a-box>
        <a-text value="Hablar con el Ingeniero" align="center" color="#000000" position="0 0 1.2" rotation="0 0 0" width="10"></a-text>
      </a-entity>

      <!-- PANEL DE PREGUNTAS -->
      <a-entity id="panel-preguntas" position="78.649 5 20" rotation="0 270 0" visible="false">
        <a-plane width="15" height="18" color="#ffffff" opacity="0.9"></a-plane>
        <a-text value="Selecciona una pregunta :" position="0 0.7 0.01" align="center" width="2" color="#000"></a-text>

        <a-entity id="opcion1" question-id="1" position="0 5 0.02">
          <a-plane width="12" height="2.5" color="#EEE" opacity="0.8"></a-plane>
          <a-text value="驴Que es MRU?" align="center" width="15" color="#000" position="0 0 0.01"></a-text>
        </a-entity>

        <a-entity id="opcion2" question-id="2" position="0 2 0.02">
          <a-plane width="12" height="2.5" color="#EEE" opacity="0.8"></a-plane>
          <a-text value="驴Cu谩l es la f贸rmula principal del MRU?" align="center" width="15" color="#000" position="0 0 0.01"></a-text>
        </a-entity>

        <a-entity id="opcion3" question-id="3" position="0 -1 0.02">
          <a-plane width="12" height="2.5" color="#EEE" opacity="0.8"></a-plane>
          <a-text value="驴C贸mo se calcula la velocidad en el MRU?" align="center" width="15" color="#000" position="0 0 0.01"></a-text>
        </a-entity>

        <a-entity id="opcion4" question-id="4" position="0 -4 0.02">
          <a-plane width="12" height="2.5" color="#EEE" opacity="0.8"></a-plane>
          <a-text value="驴Qu茅 representa la pendiente en una gr谩fica de posici贸n vs. tiempo?" align="center" width="15" color="#000" position="0 0 0.01"></a-text>
        </a-entity>

        <a-entity id="opcionSalir" question-id="exit" position="0 -7 0.02">
          <a-plane width="12" height="2.5" color="#DDD" opacity="0.8"></a-plane>
          <a-text value="Esta bien, gracias Inge" align="center" width="15" color="#666" position="0 0 0.01"></a-text>
        </a-entity>
      </a-entity>

        <!-- MESAS-->
         <a-entity gltf-model="#modelomesa" scale="9 5 8" position="0.759 -5.366 -2"></a-entity>
         <a-entity gltf-model="#modelomesa" scale="9 5 8" position="0.759 -5.263 -26.163"></a-entity>
         <a-entity gltf-model="#modelomesa" scale="9 5 8" position="0.759 -5.263 -53.931"></a-entity>
         <a-entity gltf-model="#modelomesa" scale="9 5 8" position="46.643 -5.263 -2"></a-entity>
         <a-entity gltf-model="#modelomesa" scale="9 5 8" position="46.643 -5.263 -53.931"></a-entity>
         <a-entity gltf-model="#modelomesa" scale="9 5 8" position="46.643 -5.263 -26.163"></a-entity>
         
         <!-- barraroja-->
        <a-box color="#F63030" width="12" height="0.6" depth="0.6" position="0 -2.1 -2"></a-box>
        <a-box color="#111111" width="12" height="0.61" depth="0.61" position="0 -2.1 -2" wireframe="true"></a-box> 
        <!-- cajitasblancascon borde negro-->
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="-5.5 -2.6 -2" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="-5.5 -2.6 -2"></a-box>
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="5.5 -2.6 -2" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="5.5 -2.6 -2"></a-box>
         <!-- barraroja-->
        <a-box color="#F63030" width="12" height="0.6" depth="0.6" position="0 -2.1 -26.030"></a-box>
        <a-box color="#111111" width="12" height="0.61" depth="0.61" position="0 -2.1 -26.030" wireframe="true"></a-box> 
        <!-- cajitasblancascon borde negro-->
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="-5.5 -2.6 -26.030" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="-5.5 -2.6 -26.030"></a-box>
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="5.5 -2.6 -26.030" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="5.5 -2.6 -26.030"></a-box>
        <!-- barraroja-->
        <a-box color="#F63030" width="12" height="0.6" depth="0.6" position="46.767 -2.1 -2"></a-box>
        <a-box color="#111111" width="12" height="0.61" depth="0.61" position="46.767 -2.1 -2" wireframe="true"></a-box> 
        <!-- cajitasblancascon borde negro-->
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="41.4 -2.6 -2" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="41.4 -2.6 -2"></a-box>
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="52.4 -2.6 -2" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="52.4 -2.6 -2"></a-box>
        <!-- barraroja-->
        <a-box color="#F63030" width="12" height="0.6" depth="0.6" position="46.767 -2.1 -26.030"></a-box>
        <a-box color="#111111" width="12" height="0.61" depth="0.61" position="46.767 -2.1 -26.030" wireframe="true"></a-box> 
        <!-- cajitasblancascon borde negro-->
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="41.4 -2.6 -26.030" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="41.4 -2.6 -26.030"></a-box>
        <a-box color="#000000" width="0.41" height="0.41" depth="0.41" position="52.4 -2.6 -26.030" wireframe="true"></a-box>
        <a-box color="#cdcdcd" width="0.4" height="0.4" depth="0.4" position="52.4 -2.6 -26.030"></a-box>

        <!-- plataforma MRU-->
        <a-entity gltf-model="#modeloriel" rotation="0 -180 0" position="0 -1.2 -2" scale="2.1 2.1 2.1"></a-entity>
        <a-entity gltf-model="#modeloriel" rotation="0 -180 0" position="0 -1.2 -26.030" scale="2.1 2.1 2.1"></a-entity>
        <a-entity gltf-model="#modeloriel" rotation="0 -180 0" position="46.767 -1.2 -2" scale="2.1 2.1 2.1"></a-entity>
        <a-entity gltf-model="#modeloriel" rotation="0 -180 0" position="46.767 -1.2 -26.030" scale="2.1 2.1 2.1"></a-entity>
        
        <!-- estantes-->
        <a-entity gltf-model="#estante" rotation="0 -90 0" position="98.692 -7 0" scale="1 0.7 1"></a-entity>
        <a-entity gltf-model="#estante" rotation="0 -90 0" position="98.692 -7 -25" scale="1 0.7 1"></a-entity>
        <a-entity gltf-model="#estante" rotation="0 -90 0" position="98.692 -7 -50" scale="1 0.7 1"></a-entity>
        <a-entity gltf-model="#estante" rotation="0 -90 0" position="98.692 -7 -75" scale="1 0.7 1"></a-entity>
        
        <!-- componentes-->
        <a-entity class="interactable" gltf-model="#componentes1" position="76.005 0 1" scale="2 2 2"></a-entity>
        <a-entity class="interactable" gltf-model="#componentes1" position="76.005 0 -2" scale="2 2 2"></a-entity>
         <a-entity class="interactable" gltf-model="#componentes2" position="76.005 0 5" scale="2 2 2"></a-entity>
        <a-entity class="interactable" gltf-model="#componentes2" position="76.005 0 8" scale="2 2 2"></a-entity>

        <!-- ventanas-->
        <a-entity gltf-model="#ventana" rotation="-180 0 0" position="0 15 -90" scale="6 7 7"></a-entity>
        <a-entity gltf-model="#ventana" rotation="-180 0 0" position="20 15 -90" scale="6 7 7"></a-entity>
        <a-entity gltf-model="#ventana" rotation="-180 0 0" position="40 15 -90" scale="5 7 7"></a-entity>
        <a-entity gltf-model="#ventana" rotation="-180 0 0" position="49 15 -90" scale="5 7 7"></a-entity>

        <!-- maquina de aire MRU-->
        <a-entity id="maquinaaire" gltf-model="#modelomaquina" position="-5.6 -1.5 0" scale="1.5 2.3 2.3"></a-entity>
        <a-box color="#502c20" width="2" height="0.4" depth="2" position="-5.6 -2.5 0"></a-box>     
        
        <!-- CARRITO 1 -->
        <a-entity id="carrito1" gltf-model="#modelocarrito" position="-4 -1 -1.5" scale="0.55 0.55 0.55" rotation="0 90 0" class="interactable"></a-entity>
        
        <!-- FOTOPUERTAS -->
        <a-box id="fotopuerta1" position="-3.7 -0 -1.8" width="0.05" height="0.5" depth="0.01" color="black"></a-box>
        <a-box id="fotopuerta2" position="4.5 -0 -1.8" width="0.05" height="0.5" depth="0.01" color="black"></a-box>

        <a-entity id="vernier" position="2 -2.5 1">
            <a-entity gltf-model="#modelo-vernier" rotation="0 270 0" scale="1 1 1"></a-entity>
            <a-plane id="pantalla" width="0.5" height="0.25" position="0 0 0.143" color="#222">
            <a-text id="resultado-texto" value="Resultados: --" align="center" color="lime" width="0.8" position="0 0 0.01"></a-text>
            </a-plane>
        </a-entity>

        <!-- PIZARRN -->
        <a-entity id="pizarron" position="30.291 6 29.5" rotation="-180 0 180">
            <a-plane width="25" height="15" color="#919191"></a-plane>
            <a-text id="pizarron-titulo" value="Resultados del Experimento" color="#000000" position="0.5 6 0.02" align="center" width="23"></a-text>
            <a-text id="linea3" value="Velocidad inicial: -- m/s" color="#000000" position="-11 4 0.02" width="21"></a-text>            
            <a-text id="linea5" value="Tiempo estimado: -- s" color="#000000" position="-11 2 0.02" width="21"></a-text>
            <a-text id="linea6" value="Distancia: -- m" color="#000000" position="-11 0 0.02" width="21"></a-text>
            <a-text id="linea7" value="Ecuacion: x = x0 + vt: -- (m/s)" color="#8cbbf0" position="-11 -2 0.01" width="21"></a-text>
        </a-entity>
        
        <a-image id="grafico-mru" position="23.738 6 29.2" width="10" height="8" rotation="-180 0 180"></a-image>
        
        <!-- Postes decorativos -->
        <a-box color="#502c20" width="0.71" height="15" depth="0.71" position="43.204 6 29.5"></a-box>
        <a-box color="#502c20" width="0.71" height="15" depth="0.71" position="17.792 6 29.5"></a-box>
        <a-box color="#502c20" width="0.71" height="25.5" depth="0.71" position="30.689 -1.5 29.5" rotation="-90 -90 0"></a-box>
        <a-box color="#502c20" width="0.71" height="25.5" depth="0.71" position="30.689 13.5 29.5" rotation="-90 -90 0"></a-box>
        
        <!-- Botones MRU-->
        <a-box id="boton-encender" position="-5 -1.5 0" width="0.5" height="0.5" rotation ="0 90 0" depth="0.5" color="#4CC3D9"></a-box>
        <a-box id="boton-reiniciar" position="-17.1 2 -4" width="3" height="3" rotation="0 270 0" depth="0.5" color="#FFCC00"></a-box>
        <a-text value="Reiniciar" position="-17.1 0 -4" align="center" rotation="0 -270 0" color="black" width="10"></a-text>
        <a-box id="boton-detener" position="-17.1 2 2" width="3" height="3" rotation="0 270 0" depth="0.5" color="#FF6666"></a-box>
        <a-text value="Detener" position="-17.1 0 2" align="center" rotation="0 -270 0" color="black" width="10"></a-text>

        <!-- LOGICA PRINCIPAL E INTEGRACIN DE EXCEL -->
        <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DOM ---
            const carrito = document.querySelector('#carrito1');
            const resultadoTexto = document.querySelector('#resultado-texto');
            const linea3 = document.querySelector('#linea3');
            const linea5 = document.querySelector('#linea5');
            const linea6 = document.querySelector('#linea6');
            const linea7 = document.querySelector('#linea7');

            const botonEncender = document.querySelector('#boton-encender');
            const botonDetener = document.querySelector('#boton-detener');
            const botonReiniciar = document.querySelector('#boton-reiniciar');
            const botonDescargar = document.querySelector('#boton-descargar');
            const inputVelocidad = document.querySelector('#vel-input');

            const distanciaFotopuertas = 2; // metros
            let inicioDetectado = false;
            let finDetectado = false;
            let tiempoInicio = 0;
            let tiempoFin = 0;
            let animacionActiva = false;
            
            // Variables para almacenar datos para el Excel
            let datosTiempos = [];
            let datosPosiciones = [];
            let velocidadActual = 0;

            function limpiarAnimaciones() {
                carrito.removeAttribute('animation');
                inicioDetectado = false;
                finDetectado = false;
            }

            // --- BOTN ENCENDER ---
            botonEncender.addEventListener('click', () => {
                if(animacionActiva) return;

                const velocidad = parseFloat(inputVelocidad.value);
                if(isNaN(velocidad) || velocidad <= 0){
                    alert("Introduce una velocidad v谩lida mayor a 0.");
                    return;
                }
                
                velocidadActual = velocidad;

                //  Validar que el carrito est茅 colocado justo antes de la fotopuerta 1
                const posX = carrito.object3D.position.x;
                if(posX < -4 || posX > -0.5){
                    const modal = document.getElementById('mensajeError');
                    modal.style.display = 'block';
                    setTimeout(() => modal.style.display = 'none', 5000); 
                    return;
                }
                
                const posFotopuerta2 = 2; // posici贸n X de la fotopuerta 2

                if(posX >= posFotopuerta2 - 0.05 && posX <= posFotopuerta2 + 0.05){
                    const modal = document.getElementById('mensajeExito');
                    modal.style.display = 'block';
                    setTimeout(() => modal.style.display = 'none', 5000); 
                }

                animacionActiva = true;
                botonDescargar.style.display = 'none'; // Ocultar descargar al empezar

                //  Reiniciar posici贸n inicial
                carrito.setAttribute('position', '-4 -1 -1.5');

                //  Recorrido largo 
                const distancia = 8.5;
                const duracion = (distancia / velocidad) * 1000;

                carrito.setAttribute('animation', {
                    property: 'position',
                    to: '4.5 -1 -1.5',
                    dur: duracion,
                    easing: 'linear'
                });

                resultadoTexto.setAttribute('value', 'Midiendo velocidad...');
                linea3.setAttribute('value', `Velocidad ingresada: ${velocidad.toFixed(2)} m/s`);
                linea5.setAttribute('value', `Tiempo estimado: ${(distancia / velocidad).toFixed(2)} s`);
                linea6.setAttribute('value', `Distancia: ${distancia.toFixed(2)} m`);
                linea7.setAttribute('value', `Ecuaci贸n: x = x0 + vt`);

                dibujarGraficoMRU(velocidad, distancia / velocidad);

                const intervalo = setInterval(() => {
                    const posX = carrito.object3D.position.x;

                    // 憋 Fotopuerta 1 (x = 0)
                    if(!inicioDetectado && posX >= 0){
                        tiempoInicio = performance.now();
                        inicioDetectado = true;
                    }

                    // 憋 Fotopuerta 2 (x = 2)
                    if(inicioDetectado && !finDetectado && posX >= 2){
                        tiempoFin = performance.now();
                        finDetectado = true;

                        const tiempoSegundos = (tiempoFin - tiempoInicio) / 1000;
                        const velocidadCalculada = distanciaFotopuertas / tiempoSegundos;

                        resultadoTexto.setAttribute('value', `Velocidad ~ ${velocidadCalculada.toFixed(2)} m/s`);
                        linea3.setAttribute('value', `Velocidad ingresada: ${velocidad.toFixed(2)} m/s | Medida: ${velocidadCalculada.toFixed(2)} m/s`);
                        linea5.setAttribute('value', `Tiempo medido: ${tiempoSegundos.toFixed(2)} s`);
                        linea6.setAttribute('value', `Distancia: ${distanciaFotopuertas.toFixed(2)} m`);
                        linea7.setAttribute('value', `Ecuaci贸n: x = x0 + vt: ${velocidadCalculada.toFixed(2)}*t`);

                        // Redibujar gr谩fico con el tiempo real medido y preparar datos
                        dibujarGraficoMRU(velocidad, tiempoSegundos);
                        
                        // Mostrar bot贸n de descarga al terminar
                        botonDescargar.style.display = 'block';
                        
                        clearInterval(intervalo);
                    }

                    if(posX > 5 || finDetectado){
                        clearInterval(intervalo);
                    }
                }, 50);
            });

            botonDetener.addEventListener('click', () => {
                limpiarAnimaciones();
                animacionActiva = false;
                resultadoTexto.setAttribute('value', 'Movimiento detenido');
            });

            botonReiniciar.addEventListener('click', () => {
                limpiarAnimaciones();
                carrito.setAttribute('position', '-1 -2.47 1.5');
                animacionActiva = false;
                botonDescargar.style.display = 'none';
                resultadoTexto.setAttribute('value', 'Resultados: --');
                linea3.setAttribute('value', 'Velocidad inicial: -- m/s');
                linea5.setAttribute('value', 'Tiempo estimado: -- s');
                linea6.setAttribute('value', 'Distancia: -- m');
                linea7.setAttribute('value', 'Ecuaci贸n: x = x0 + vt: -- (m/s)');
            });

            // --- FUNCIN PARA DIBUJAR GRFICO (Y llenar datos para Excel) ---
            function dibujarGraficoMRU(velocidad, tiempoTotal){
                const canvas = document.getElementById('grafico');
                const ctx = canvas.getContext('2d');

                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height); // Fondo blanco para que salga bien en Excel

                // ejes
                ctx.beginPath();
                ctx.moveTo(40, 260);
                ctx.lineTo(380, 260);
                ctx.moveTo(40, 260);
                ctx.lineTo(40, 20);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.stroke();

                // marcas eje X
                ctx.fillStyle = '#000';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const pasosX = 5;
                for(let i=0;i<=pasosX;i++){
                    const t = i*tiempoTotal/pasosX;
                    const xCanvas = 40 + (t/tiempoTotal)*340;
                    ctx.beginPath();
                    ctx.moveTo(xCanvas, 260);
                    ctx.lineTo(xCanvas, 255);
                    ctx.stroke();
                    ctx.fillText(t.toFixed(1), xCanvas, 265);
                }
                ctx.fillText('Tiempo (s)', 210, 280);

                // marcas eje Y
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                const maxDistancia = velocidad * tiempoTotal;
                const pasosY = 5;
                for(let i=0;i<=pasosY;i++){
                    const d = i*maxDistancia/pasosY;
                    const yCanvas = 260 - (d/maxDistancia)*240;
                    ctx.beginPath();
                    ctx.moveTo(40, yCanvas);
                    ctx.lineTo(35, yCanvas);
                    ctx.stroke();
                    ctx.fillText(d.toFixed(1), 30, yCanvas);
                }
                ctx.fillText('Posici贸n (m)', 10, 140);

                // linea MRU
                ctx.beginPath();
                ctx.moveTo(40,260);

                const pasos = 50;
                // Limpiar arrays globales para exportaci贸n
                datosTiempos = [];
                datosPosiciones = [];

                for(let i=0;i<=pasos;i++){
                    let t = i*tiempoTotal/pasos;
                    let x = velocidad*t;

                    let xCanvas = 40 + (t/tiempoTotal)*340;
                    let yCanvas = 260 - (x/maxDistancia)*240;

                    ctx.lineTo(xCanvas, yCanvas);
                    
                    // Guardar datos para exportar luego
                    datosTiempos.push(t.toFixed(3));
                    datosPosiciones.push(x.toFixed(3));
                }

                ctx.strokeStyle = '#00f';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Actualizar imagen en A-Frame
                const image = document.getElementById('grafico-mru');
                if(image) image.setAttribute('src', canvas.toDataURL());
            }

            // --- NUEVA FUNCIN: EXPORTAR A EXCEL CON IMAGEN ---
            botonDescargar.addEventListener('click', async () => {
                if (datosTiempos.length === 0) {
                    alert("No hay datos para exportar. Ejecuta la simulaci贸n primero.");
                    return;
                }

                // Crear libro y hoja
                const workbook = new ExcelJS.Workbook();
                const sheet = workbook.addWorksheet('Datos MRU');

                // Encabezados
                sheet.columns = [
                    { header: 'Tiempo (s)', key: 't', width: 15 },
                    { header: 'Posici贸n (m)', key: 'x', width: 15 },
                    { header: '', key: 'empty', width: 5 }, // Espacio
                    { header: 'Resumen', key: 'resumen', width: 30 }
                ];

                // Estilos de encabezado
                sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };

                // Llenar datos num茅ricos
                for(let i=0; i < datosTiempos.length; i++) {
                    const row = sheet.addRow({
                        t: parseFloat(datosTiempos[i]),
                        x: parseFloat(datosPosiciones[i])
                    });
                    
                    // Agregar resumen solo en las primeras filas
                    if(i === 0) sheet.getCell('D2').value = `Velocidad Constante: ${velocidadActual} m/s`;
                    if(i === 1) sheet.getCell('D3').value = "Tipo de Movimiento: MRU";
                    if(i === 2) sheet.getCell('D4').value = `Distancia Total: ${datosPosiciones[datosPosiciones.length-1]} m`;
                }

                // Capturar imagen del canvas
                const canvas = document.getElementById('grafico');
                // Convertir a imagen base64
                const imgData = canvas.toDataURL('image/png');

                // Agregar imagen al workbook
                const imageId = workbook.addImage({
                    base64: imgData,
                    extension: 'png',
                });

                // Posicionar imagen en la hoja (Columna D, Fila 6)
                sheet.addImage(imageId, {
                    tl: { col: 3, row: 5 },
                    ext: { width: 400, height: 300 }
                });

                // Generar buffer y descargar
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                const url = window.URL.createObjectURL(blob);
                const anchor = document.createElement("a");
                anchor.href = url;
                anchor.download = "Reporte_MRU_con_Grafico.xlsx";
                anchor.click();
                window.URL.revokeObjectURL(url);
            });

            // --- ARRASTRE MODELOS GLTF (C贸digo original preservado) ---
            const scene = document.querySelector('a-scene');
            const camera = scene.querySelector('[camera]');
            const interactables = document.querySelectorAll('.interactable');

            let grabbedEl = null;
            let offset = new THREE.Vector3();
            let plane = new THREE.Plane();
            let raycaster = new THREE.Raycaster();
            let mouse = new THREE.Vector2();
            let interactableMeshes = [];

            interactables.forEach(el => {
                el.addEventListener('model-loaded', () => {
                    el.object3D.traverse(node => {
                        if(node.isMesh){
                            node.el = el;
                            interactableMeshes.push(node);
                        }
                    });
                });
            });

            window.addEventListener('mousedown', e => {
                if(e.button !== 0) return;
                mouse.x = (e.clientX / window.innerWidth)*2 - 1;
                mouse.y = -(e.clientY / window.innerHeight)*2 + 1;
                raycaster.setFromCamera(mouse, camera.getObject3D('camera'));
                const intersects = raycaster.intersectObjects(interactableMeshes, true);
                if(intersects.length > 0){
                    grabbedEl = intersects[0].object.el;
                    plane.setFromNormalAndCoplanarPoint(
                        new THREE.Vector3(0,0,1).applyQuaternion(camera.object3D.quaternion),
                        intersects[0].point
                    );
                    offset.copy(intersects[0].point).sub(grabbedEl.object3D.position);
                }
            });

            window.addEventListener('mouseup', e => {
                if(e.button !== 0) return;
                grabbedEl = null;
            });

            window.addEventListener('mousemove', e => {
                if(!grabbedEl) return;
                mouse.x = (e.clientX / window.innerWidth)*2 - 1;
                mouse.y = -(e.clientY / window.innerHeight)*2 + 1;
                raycaster.setFromCamera(mouse, camera.getObject3D('camera'));
                const intersectionPoint = new THREE.Vector3();
                raycaster.ray.intersectPlane(plane, intersectionPoint);
                if(intersectionPoint){
                    grabbedEl.object3D.position.copy(intersectionPoint.sub(offset));
                }
            });
        });
        </script>

        <!-- SECCIN AVATAR DOCENTE -->
        <script>
        const botonDocente = document.querySelector('#boton-docente');
        const panelPreguntas = document.querySelector('#panel-preguntas');
        const textoDialogo = document.querySelector('#texto-dialogo');

        const respuestas = {
            "1": "Es un tipo de movimiento en l铆nea recta donde un objeto se desplaza a velocidad constante, sin aceleraci贸n.",
            "2": "La f贸rmula es: d = v * t, donde d es la distancia, v la velocidad y t el tiempo.",
            "3": "Se calcula dividiendo la distancia recorrida entre el tiempo: v = d / t.",
            "4": "Representa la velocidad del objeto; una pendiente constante indica velocidad constante.",
        };

        const despedidas = [
            "Muy bien, contin煤a con el experimento.",
            "Listo, seguimos luego.",
            "Hasta luego, buen trabajo."
        ];

        botonDocente.addEventListener('click', () => {
            panelPreguntas.setAttribute('visible', true);
            textoDialogo.setAttribute('value', "Hola, 驴qu茅 deseas saber?");
        });

        ['opcion1', 'opcion2', 'opcion3', 'opcion4', 'opcionSalir'].forEach(id => {
            const opcion = document.querySelector(`#${id}`);
            const questionId = opcion.getAttribute('question-id');

            opcion.addEventListener('click', () => {
            if (questionId === 'exit') {
                const despedida = despedidas[Math.floor(Math.random() * despedidas.length)];
                textoDialogo.setAttribute('value', despedida);
                setTimeout(() => panelPreguntas.setAttribute('visible', false), 1500);
            } else {
                textoDialogo.setAttribute('value', respuestas[questionId]);
            }
            });
        });
        </script>

        <!-- C谩mara con cursor -->
        <a-entity position="0 1.6 0">
            <a-entity camera look-controls wasd-controls position="0 0 0">
                <a-cursor></a-cursor>
            </a-entity>
        </a-entity>
        
        <!-- Escenario-->
        <a-light type="ambient" color="#FFFFFF" intensity="0.6"></a-light>
        <a-light type="directional" color="#FFFFFF" intensity="1.5" position="0 -6 -6"></a-light>
        <a-light type="directional" color="#FFFFFF" intensity="0.5" position="0 10 10"></a-light>
        <a-sky color="#ddddff"></a-sky>
        
    </a-scene>
</body>
</html>